<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator Medis - Murni Teguh Memorial Hospital</title>
    <style>
        /* --- CSS STYLE START --- */
        * { box-sizing: border-box; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        body { font-family: 'Arial', sans-serif; font-size: 13px; background-color: #f0f2f5; margin: 0; padding: 20px; }
        .container { max-width: 850px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        .header-container { text-align: center; margin-bottom: 5px; }
        .header-image { max-width: 100%; height: auto; display: block; margin: 0 auto; }

        /* MENU TABS */
        .menu-container { display: flex; justify-content: center; gap: 5px; margin-bottom: 20px; }
        .btn-tab { padding: 10px 20px; border: none; background: #ddd; cursor: pointer; border-radius: 5px; font-weight: bold; }
        .btn-tab.active { background: #4CAF50; color: white; }

        /* DATA PASIEN */
        .patient-total-wrapper { display: flex; gap: 20px; margin-bottom: 20px; border: 1px solid #ddd; padding: 15px; border-radius: 8px; align-items: stretch; }
        .patient-info { flex: 1; }
        /* Grid System untuk titik dua sejajar */
        .info-line { display: grid; grid-template-columns: 140px 10px auto; margin-bottom: 5px; border-bottom: 1px dashed #eee; padding-bottom: 2px; }
        .info-line .label { font-weight: bold; color: #555; }

        /* OUTPUT BOXES (KOTAK HIJAU) */
        .output-box { width: 220px; padding: 15px; border: 2px solid #4CAF50; border-radius: 8px; text-align: center; background: #e8f5e9; display: none; flex-direction: column; justify-content: center; }
        .output-title { font-weight: bold; color: #2E7D32; margin-bottom: 5px; }
        .output-value { font-size: 24px; font-weight: bold; color: #333; }
        
        /* INPUT FORMS */
        .input-form { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; padding: 15px; background-color: #f9f9f9; border-radius: 8px; border: 1px solid #eee; margin-bottom: 20px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-weight: bold; font-size: 11px; margin-bottom: 3px; }
        .form-group input, .form-group select { padding: 6px; border: 1px solid #ccc; border-radius: 4px; width: 100%; }

        /* CHECKBOX GRID */
        .checkbox-grid { grid-column: 1 / -1; display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .form-section-title { grid-column: 1 / -1; font-weight: bold; margin-top: 10px; border-bottom: 1px solid #ddd; padding-bottom: 5px; }

        /* TABLES */
        .scoring-table { width: 100%; border-collapse: collapse; margin-top: 15px; page-break-inside: avoid; }
        .scoring-table th, .scoring-table td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 12px; }
        .scoring-table th { background-color: #f2f2f2; }
        .highlight-natrium { background-color: #e8f5e9; font-weight: bold; }

        /* FOOTER */
        .footer-section { display: flex; justify-content: space-between; align-items: flex-end; margin-top: 20px; page-break-inside: avoid; }
        .dpjp-section { text-align: center; min-width: 200px; margin-left: auto; }
        .dpjp-input { margin-top: 5px; width: 100%; padding: 5px; text-align: center; }
        .dpjp-name { margin-top: 60px; font-weight: bold; border-bottom: 1px solid #000; padding-bottom: 5px; min-height: 20px; }
        .button-container { display: flex; gap: 10px; }
        .btn-action { padding: 10px 20px; cursor: pointer; border: none; border-radius: 5px; color: white; font-weight: bold; }
        .btn-print { background: #2196F3; } 
        .btn-clear { background: #f44336; }

        /* PRINT RULES */
        @media print {
            @page { size: A4; margin: 10mm; }
            body { background: white; padding: 0; }
            .container { width: 100%; max-width: 100%; box-shadow: none; border: none; padding: 0; margin: 0; }
            .screen-only { display: none !important; }
            .patient-total-wrapper { border: 1px solid #000; }
            .footer-section { justify-content: flex-end; }
            .dpjp-section { margin-left: auto !important; }

            /* Sembunyikan semua output box & konten dulu */
            #calc-natrium-content, #calc-kalium-content, #calc-psi-content,
            #natrium-output-box, #kalium-output-box, #psi-output-box { display: none !important; }

            /* Tampilkan HANYA yang aktif berdasarkan class body */
            body.mode-psi #calc-psi-content { display: block !important; }
            body.mode-psi #psi-output-box { display: flex !important; border: 2px solid #000 !important; }

            body.mode-natrium #calc-natrium-content { display: block !important; }
            body.mode-natrium #natrium-output-box { display: flex !important; border: 2px solid #000 !important; }

            body.mode-kalium #calc-kalium-content { display: block !important; }
            body.mode-kalium #kalium-output-box { display: flex !important; border: 2px solid #000 !important; }
        }
        /* --- CSS END --- */
    </style>
</head>
<body class="mode-psi">
    <div class="container">
        <div class="header-container">
            <img src="https://github.com/didasar91/PSI-Score-Calculator/blob/main/header.jpg?raw=true" alt="Murni Teguh" class="header-image">
        </div>

        <div class="menu-container screen-only">
            <button onclick="showCalculator('psi')" id="btn-psi" class="btn-tab active">PSI Score</button>
            <button onclick="showCalculator('natrium')" id="btn-natrium" class="btn-tab">Koreksi Natrium</button>
            <button onclick="showCalculator('kalium')" id="btn-kalium" class="btn-tab">Koreksi Kalium</button>
        </div>

        <div class="patient-total-wrapper">
            <div class="patient-info">
                <div class="info-line"><span class="label">Nama</span><span>:</span><span id="displayNama">-</span></div>
                <div class="info-line"><span class="label">No. MR</span><span>:</span><span id="displayNoMR">-</span></div>
                <div class="info-line"><span class="label">Tgl Lahir</span><span>:</span><span id="displayTglLahir">-</span></div>
                <div class="info-line"><span class="label">Umur</span><span>:</span><span id="displayUmur">-</span></div>
                <div class="info-line"><span class="label">Tgl Assessment</span><span>:</span><span id="displayTglAsesmen">-</span></div>
            </div>

            <div id="psi-output-box" class="output-box green-box">
                <div class="output-title">PSI Score</div>
                <div class="output-value" id="totalScore">0</div>
                <div class="output-label">Kelas: <span id="kelasRisiko">-</span></div>
                <div class="output-label" style="font-size: 11px;">Mortality: <span id="mortalityRate">-</span></div>
            </div>

            <div id="natrium-output-box" class="output-box green-box">
                <div class="output-title">Delta Na+</div>
                <div class="output-value"><span id="displayDeltaTotal">0</span> <small>mEq</small></div>
                <div class="output-label"><span id="displayNaAwal">0</span> &rarr; <span id="displayNaTarget">0</span></div>
            </div>

            <div id="kalium-output-box" class="output-box green-box">
                <div class="output-title">Kebutuhan KCl</div>
                <div class="output-value"><span id="displayKebutuhanK">0</span> <small>mEq</small></div>
                <div class="output-label"><span id="displayKaliumSerum">0</span> &rarr; <span id="displayKTarget">0</span></div>
                <div class="output-label" style="font-size: 11px;">Delta: <span id="displayDeltaK">0</span></div>
            </div>
        </div>

        <div class="input-form screen-only">
            <div class="form-group"><label>Nama Pasien*:</label><input type="text" id="nama"></div>
            <div class="form-group"><label>No. MR (10 Digit)*:</label><input type="text" id="noMR" maxlength="10"></div>
            <div class="form-group"><label>Tgl Lahir*:</label><input type="date" id="tglLahir"></div>
            <div class="form-group"><label>Jenis Kelamin*:</label><select id="jk"><option value="L">Laki-laki</option><option value="P">Perempuan</option></select></div>
            <div class="form-group"><label>Tgl Assessment*:</label><input type="date" id="tglAsesmen"></div>
            <div class="form-group"><label>Berat Badan (kg)*:</label><input type="number" id="bb"></div>
            
            <div id="input-psi-group" style="display:contents;">
                <div class="form-section-title">Riwayat & Komorbiditas</div>
                <div class="checkbox-grid">
                    <label><input type="checkbox" class="psi-check" data-score="30" data-id="cancer"> Keganasan (+30)</label>
                    <label><input type="checkbox" class="psi-check" data-score="20" data-id="liver"> Penyakit Hati (+20)</label>
                    <label><input type="checkbox" class="psi-check" data-score="10" data-id="hf"> Gagal Jantung (+10)</label>
                    <label><input type="checkbox" class="psi-check" data-score="10" data-id="cvd"> Cerebrovascular (+10)</label>
                    <label><input type="checkbox" class="psi-check" data-score="10" data-id="renal"> Penyakit Ginjal (+10)</label>
                    <label><input type="checkbox" class="psi-check" data-score="10" data-id="nursing"> Nursing Home (+10)</label>
                </div>
                <div class="form-section-title">Pemeriksaan Fisik</div>
                <div class="checkbox-grid">
                    <label><input type="checkbox" class="psi-check" data-score="20" data-id="ams"> Ggn Kesadaran (+20)</label>
                    <label><input type="checkbox" class="psi-check" data-score="20" data-id="rr"> RR ≥30 x/m (+20)</label>
                    <label><input type="checkbox" class="psi-check" data-score="20" data-id="sys"> SBP <90 mmHg (+20)</label>
                    <label><input type="checkbox" class="psi-check" data-score="10" data-id="temp"> Suhu <35 / >40 (+10)</label>
                    <label><input type="checkbox" class="psi-check" data-score="10" data-id="pulse"> Nadi ≥125 x/m (+10)</label>
                </div>
                <div class="form-section-title">Laboratorium & Radiologi</div>
                <div class="checkbox-grid">
                    <label><input type="checkbox" class="psi-check" data-score="30" data-id="ph"> pH <7.35 (+30)</label>
                    <label><input type="checkbox" class="psi-check" data-score="20" data-id="bun"> BUN >30 (+20)</label>
                    <label><input type="checkbox" class="psi-check" data-score="20" data-id="na"> Na <130 (+20)</label>
                    <label><input type="checkbox" class="psi-check" data-score="10" data-id="glu"> GDS >250 (+10)</label>
                    <label><input type="checkbox" class="psi-check" data-score="10" data-id="hct"> Hct <30% (+10)</label>
                    <label><input type="checkbox" class="psi-check" data-score="10" data-id="po2"> pO2 <60 (+10)</label>
                    <label><input type="checkbox" class="psi-check" data-score="10" data-id="pleural"> Efusi Pleura (+10)</label>
                </div>
            </div>

            <div id="input-natrium-group" style="display:none; display:contents;">
                <div class="form-group"><label>Na Serum Awal:</label><input type="number" id="naSerum"></div>
                <div class="form-group"><label>Target Na:</label><input type="number" id="naTarget" value="135"></div>
                <div class="form-group"><label>Cairan Infus:</label>
                    <select id="naInfus"><option value="513">NaCl 3%</option><option value="154">NaCl 0.9%</option></select>
                </div>
                <div class="form-group"><label>Max Koreksi (mEq/24h):</label><input type="number" id="naKecepatan" value="8"></div>
            </div>

            <div id="input-kalium-group" style="display:none; display:contents;">
                <div class="form-group"><label>K Serum Awal:</label><input type="number" id="kSerum" step="0.1"></div>
                <div class="form-group"><label>Target K:</label><input type="number" id="kTarget" step="0.1" value="3.0"></div>
                <div class="form-group"><label>Akses Vena:</label>
                    <select id="aksesVena"><option value="perifer">Vena Perifer</option><option value="sentral">Vena Sentral</option></select>
                </div>
            </div>
        </div>

        <div id="calc-psi-content" class="calc-content"></div>
        <div id="calc-natrium-content" class="calc-content" style="display:none;"><div id="natrium-tables-container"></div></div>
        <div id="calc-kalium-content" class="calc-content" style="display:none;">
            <div id="kalium-result-table"><table class="scoring-table"><thead><tr><th>Rencana Tata Laksana</th><th>Instruksi Klinis</th></tr></thead><tbody id="kalium-instructions"></tbody></table></div>
        </div>

        <div class="footer-section">
            <div class="button-container screen-only">
                <button onclick="printAndDownload()" class="btn-action btn-print">Print / Save PDF</button>
                <button onclick="location.reload()" class="btn-action btn-clear">Clear</button>
            </div>
            <div class="dpjp-section">
                <p>Medan, <span id="displayTanggalPrint"></span></p>
                <p>Diketahui oleh,</p>
                <input type="text" id="inputDPJP" placeholder="Nama Dokter*" class="screen-only dpjp-input">
                <div id="displayDPJP" class="dpjp-name"></div>
            </div>
        </div>
    </div>

    <script>
        let currentMode = 'psi';

        function showCalculator(mode) {
            currentMode = mode;
            document.body.className = 'mode-' + mode;
            
            document.querySelectorAll('.btn-tab').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-${mode}`).classList.add('active');

            ['psi', 'natrium', 'kalium'].forEach(m => {
                document.getElementById(`calc-${m}-content`).style.display = 'none';
                document.getElementById(`${m}-output-box`).style.display = 'none';
            });
            document.getElementById(`calc-${mode}-content`).style.display = 'block';
            document.getElementById(`${mode}-output-box`).style.display = 'flex';

            document.getElementById('input-psi-group').style.display = (mode === 'psi') ? 'contents' : 'none';
            document.getElementById('input-natrium-group').style.display = (mode === 'natrium') ? 'contents' : 'none';
            document.getElementById('input-kalium-group').style.display = (mode === 'kalium') ? 'contents' : 'none';

            updateStats();
        }

        function formatDateIndo(dateString) {
            if (!dateString) return "-";
            const date = new Date(dateString);
            if (isNaN(date)) return "-";
            const months = ["Jan", "Feb", "Mar", "Apr", "Mei", "Jun", "Jul", "Agu", "Sep", "Okt", "Nov", "Des"];
            return `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()}`;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const inputs = ['nama', 'noMR', 'inputDPJP', 'tglAsesmen', 'tglLahir', 'jk', 'bb', 'naSerum', 'naTarget', 'naKecepatan', 'naInfus', 'kSerum', 'kTarget', 'aksesVena'];
            inputs.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener((el.tagName === 'SELECT' || el.type === 'date') ? 'change' : 'input', updateStats);
            });
            document.querySelectorAll('.psi-check').forEach(box => box.addEventListener('change', updateStats));
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('tglAsesmen').value = today;
            // Init tanggal print
            document.getElementById('displayTanggalPrint').textContent = formatDateIndo(today);
            
            showCalculator('psi'); 
        });

        function updateStats() {
            setText('displayNama', getValue('nama') || '-');
            setText('displayNoMR', getValue('noMR') || '-');
            setText('displayDPJP', getValue('inputDPJP') || '');
            setText('displayTglAsesmen', formatDateIndo(getValue('tglAsesmen')));
            setText('displayTglLahir', formatDateIndo(getValue('tglLahir')));
            
            // UPDATE: Tanggal Tanda Tangan Mengikuti Assessment
            setText('displayTanggalPrint', formatDateIndo(getValue('tglAsesmen')));
            
            const tgl = getValue('tglLahir');
            if (tgl) {
                const dob = new Date(tgl);
                const today = new Date();
                let age = today.getFullYear() - dob.getFullYear();
                if (today.getMonth() < dob.getMonth() || (today.getMonth() === dob.getMonth() && today.getDate() < dob.getDate())) age--;
                setText('displayUmur', age + " Tahun");
            }

            try { calculatePSI(); } catch(e) {}
            try { calculateNatrium(); } catch(e) {}
            try { calculateKalium(); } catch(e) {}
        }

        function calculatePSI() {
            let total = 0;
            let detailsTable = `<table class="scoring-table"><thead><tr><th>Parameter</th><th style="width:50px">Skor</th></tr></thead><tbody>`;
            
            const tgl = getValue('tglLahir');
            if(tgl) {
                const dob = new Date(tgl);
                const today = new Date();
                let age = today.getFullYear() - dob.getFullYear();
                if (today.getMonth() < dob.getMonth() || (today.getMonth() === dob.getMonth() && today.getDate() < dob.getDate())) age--;
                const jk = getValue('jk');
                let ageScore = (jk === 'P') ? Math.max(0, age - 10) : age;
                total += ageScore;
                detailsTable += `<tr><td>Usia (${age}) + Gender (${jk})</td><td>${ageScore}</td></tr>`;
            }
            
            document.querySelectorAll('.psi-check').forEach(c => { 
                if(c.checked) {
                    const score = parseInt(c.dataset.score);
                    total += score;
                    detailsTable += `<tr><td>${c.parentElement.innerText.split(' (+')[0]}</td><td>${score}</td></tr>`;
                }
            });
            
            detailsTable += `<tr><td><strong>TOTAL</strong></td><td><strong>${total}</strong></td></tr></tbody></table>`;
            setText('totalScore', total);
            
            let kelas = "I", mort = "0.1%";
            if(total > 130) { kelas = "V"; mort = "29.2%"; }
            else if(total >= 91) { kelas = "IV"; mort = "8.2%"; }
            else if(total >= 71) { kelas = "III"; mort = "2.8%"; }
            else if(total > 0) { kelas = "II"; mort = "0.6%"; }
            
            setText('kelasRisiko', kelas);
            setText('mortalityRate', mort);
            document.getElementById('calc-psi-content').innerHTML = detailsTable;
        }

        function calculateNatrium() {
            const bb = parseFloat(getValue('bb'));
            const naSerum = parseFloat(getValue('naSerum'));
            const naTarget = parseFloat(getValue('naTarget'));
            const naInfus = parseFloat(getValue('naInfus'));
            const kecMax = parseFloat(getValue('naKecepatan'));
            const age = parseInt(document.getElementById('displayUmur')?.innerText) || 30;
            const jk = getValue('jk');

            setText('displayNaAwal', naSerum || 0);
            setText('displayNaTarget', naTarget || 0);
            const deltaTotal = naTarget - naSerum;
            setText('displayDeltaTotal', !isNaN(deltaTotal) ? deltaTotal.toFixed(1) : 0);

            const container = document.getElementById('natrium-tables-container');
            if (!bb || isNaN(naSerum) || isNaN(naTarget) || !container) return;
            
            container.innerHTML = "";
            if (deltaTotal <= 0) { container.innerHTML = "<tr><td colspan='2'>Target tercapai / Nilai serum lebih tinggi.</td></tr>"; return; }

            let tglAsesmen = getValue('tglAsesmen') ? new Date(getValue('tglAsesmen')) : new Date();
            let factor = (age <= 18) ? 0.6 : (jk === 'L' ? (age > 65 ? 0.5 : 0.6) : (age > 65 ? 0.45 : 0.5));
            const tbw = bb * factor;
            const deltaPerLiter = (naInfus - naSerum) / (tbw + 1);

            let sisaDelta = deltaTotal;
            let hari = 1;
            while (sisaDelta > 0.01) {
                let deltaHariIni = Math.min(sisaDelta, kecMax);
                const volmL = (deltaHariIni / deltaPerLiter) * 1000;
                const botol = Math.ceil(volmL / 500);
                const speed = (volmL / 24).toFixed(1);

                let d = new Date(tglAsesmen); d.setDate(tglAsesmen.getDate() + (hari - 1));
                const months = ["Jan","Feb","Mar","Apr","Mei","Jun","Jul","Agu","Sep","Okt","Nov","Des"];
                const dateStr = `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`;

                container.innerHTML += `
                <table class="scoring-table">
                    <thead><tr><th style="background:${hari === 1 ? '#4CAF50' : '#2196F3'}; color:white;">Rencana Hari ke-${hari} (${dateStr})</th><th>Hasil</th></tr></thead>
                    <tbody>
                        ${hari === 1 ? `<tr><td>TBW</td><td>${tbw.toFixed(1)} L</td></tr>` : ''}
                        <tr><td>Target Δ Na+</td><td>${deltaHariIni.toFixed(1)} mEq/L</td></tr>
                        <tr class="highlight-natrium"><td>Kebutuhan</td><td>${botol} Botol (Total ${volmL.toFixed(0)} mL)</td></tr>
                        <tr class="highlight-natrium"><td>Kecepatan</td><td>${speed} mL/jam</td></tr>
                    </tbody>
                </table>`;
                sisaDelta -= deltaHariIni;
                hari++;
                if(hari > 7) break;
            }
        }

        function calculateKalium() {
            const bb = parseFloat(getValue('bb'));
            const kSerum = parseFloat(getValue('kSerum'));
            const kTarget = parseFloat(getValue('kTarget')) || 3.0;
            const akses = getValue('aksesVena');
            
            setText('displayKaliumSerum', kSerum || 0);
            setText('displayKTarget', kTarget);
            const deltaK = kTarget - kSerum;
            setText('displayDeltaK', !isNaN(deltaK) && deltaK > 0 ? deltaK.toFixed(1) : "0");
            
            const kebutuhan = 0.3 * bb * (kTarget - kSerum);
            setText('displayKebutuhanK', !isNaN(kebutuhan) && kebutuhan > 0 ? kebutuhan.toFixed(1) : "0");
            
            const container = document.getElementById('kalium-instructions');
            if (!bb || isNaN(kSerum) || !container) return;

            if (kSerum >= kTarget) { container.innerHTML = `<tr><td colspan="2" style="text-align:center; color:green;">Kadar Normal.</td></tr>`; return; }

            const jumlahBotol = Math.ceil(kebutuhan / 25);
            const obatVol = jumlahBotol * 25;
            let rows = `
                <tr><td>Kalium Serum</td><td>${kSerum.toFixed(2)} mEq/L</td></tr>
                <tr><td>Target Koreksi</td><td>${kTarget.toFixed(1)} mEq/L</td></tr>
                <tr><td>Dosis Total</td><td><strong>${kebutuhan.toFixed(1)} mEq</strong> (${jumlahBotol} Botol KCl)</td></tr>
            `;

            if (akses === 'sentral') {
                const p1 = jumlahBotol * 100; const t1 = p1 + obatVol; const s1 = (t1 / 24).toFixed(1);
                const p2 = jumlahBotol * 500; const t2 = p2 + obatVol; const s2 = (t2 / 24).toFixed(1);
                rows += `
                    <tr style="background:#e3f2fd;"><td colspan="2" style="font-weight:bold; text-align:center;">OPSI VENA SENTRAL</td></tr>
                    <tr><td><strong>Opsi A (Pekat)</strong></td><td>Pelarut: ${p1} mL NaCl<br>Total: ${t1} mL<br>Kecepatan: <strong>${s1} mL/jam</strong></td></tr>
                    <tr><td><strong>Opsi B (Encer)</strong></td><td>Pelarut: ${p2} mL NaCl<br>Total: ${t2} mL<br>Kecepatan: <strong>${s2} mL/jam</strong></td></tr>
                `;
            } else {
                const pP = jumlahBotol * 500; const tP = pP + obatVol; const sP = (tP / 24).toFixed(1);
                rows += `
                    <tr><td>Akses Vena</td><td>Vena Perifer Besar</td></tr>
                    <tr style="background:#fff3e0;"><td>Cairan Pelarut</td><td><strong>${pP} mL NaCl 0.9%</strong></td></tr>
                    <tr style="background:#fff3e0;"><td>Volume Total Campuran</td><td><strong>${tP} mL</strong></td></tr>
                    <tr class="highlight-natrium"><td>Kecepatan Infus</td><td><strong>${sP} mL/jam</strong></td></tr>
                `;
            }
            container.innerHTML = rows;
        }

        function getValue(id) { return document.getElementById(id)?.value; }
        function setText(id, txt) { const el = document.getElementById(id); if (el) el.innerText = txt; }
        function printAndDownload() { window.print(); }
    </script>
</body>
</html>
